x-image: &image
  build:
    context: .
    dockerfile: images/custom/Containerfile
    args:
      APPS_JSON_BASE64: ${APPS_JSON_BASE64}
      FRAPPE_BRANCH: ${FRAPPE_BRANCH:-version-15}
      FRAPPE_PATH: ${FRAPPE_PATH:-https://github.com/frappe/frappe}
      PYTHON_VERSION: ${PYTHON_VERSION:-3.11}
      NODE_VERSION: ${NODE_VERSION:-18}
  pull_policy: always
  restart: unless-stopped

x-after_cfg: &after_cfg
  depends_on:
    configurator:
      condition: service_completed_successfully

x-backend: &backend
  <<: [*image, *after_cfg]
  environment:
    NODE_OPTIONS: "--max-old-space-size=1024"
    ESBUILD_MAX_WORKERS: "1"
  volumes:
    - sites:/home/frappe/frappe-bench/sites
    - assets:/home/frappe/frappe-bench/sites/assets

services:
  # Infra bÃ¡sica
  redis-cache:
    image: redis:6-alpine
  redis-queue:
    image: redis:6-alpine
  redis-socketio:
    image: redis:6-alpine
  db:
    image: mariadb:10.6
    environment:
      MYSQL_ROOT_PASSWORD: superStrongRootPass_9H!x
    volumes:
      - db-data:/var/lib/mysql

  # Configurador: escribe common_site_config.json
  configurator:
    <<: *backend
    entrypoint: ["bash","-lc"]
    command: >
      ls -1 apps > sites/apps.txt;
      bench set-config -g db_host db;
      bench set-config -gp db_port 3306;
      bench set-config -g redis_cache "redis://redis-cache:6379";
      bench set-config -g redis_queue "redis://redis-queue:6379";
      bench set-config -g redis_socketio "redis://redis-queue:6379";
      bench set-config -gp socketio_port 9000;

  backend:
    <<: *backend

  websocket:
    <<: *image
    <<: *after_cfg
    command: ["node","/home/frappe/frappe-bench/apps/frappe/socketio.js"]
    volumes:
      - sites:/home/frappe/frappe-bench/sites

  queue-short:
    <<: *backend
    command: ["bench","worker","--queue","short,default"]

  queue-long:
    <<: *backend
    command: ["bench","worker","--queue","long,default,short"]

  scheduler:
    <<: *backend
    command: ["bench","schedule"]

  frontend:
    <<: *image
    environment:
      BACKEND: backend:8000
      SOCKETIO: websocket:9000
      FRAPPE_SITE_NAME_HEADER: ${FRAPPE_SITE_NAME_HEADER:-$${host}}
      UPSTREAM_REAL_IP_ADDRESS: ${UPSTREAM_REAL_IP_ADDRESS:-127.0.0.1}
      UPSTREAM_REAL_IP_HEADER: ${UPSTREAM_REAL_IP_HEADER:-X-Forwarded-For}
      UPSTREAM_REAL_IP_RECURSIVE: ${UPSTREAM_REAL_IP_RECURSIVE:-off}
      PROXY_READ_TIMEOUT: ${PROXY_READ_TIMEOUT:-120}
      CLIENT_MAX_BODY_SIZE: ${CLIENT_MAX_BODY_SIZE:-50m}
    command: ["nginx-entrypoint.sh"]
    volumes:
      - sites:/home/frappe/frappe-bench/sites
    depends_on:
      - backend
      - websocket

  # 1) Crear el sitio (una sola vez). Tras OK, se auto-exit.
  create-site:
    image: frappe/erpnext:version-15
    depends_on:
      - db
      - redis-cache
      - redis-queue
      - redis-socketio
      - backend
    command:
      - bash
      - -lc
      - >
        bench new-site crm.apps.asomstudio.ai
        --mariadb-root-password 'superStrongRootPass_9H!x'
        --admin-password 'Admin_1sStrong'
        --db-name frappe --verbose
        && bench --site crm.apps.asomstudio.ai set-config enable_scheduler 1
    restart: "no"
    volumes:
      - sites:/home/frappe/frappe-bench/sites
      - assets:/home/frappe/frappe-bench/sites/assets

  # 2) Instalar la app CRM sobre el sitio (una sola vez). Tras OK, se auto-exit.
  post-install-crm:
    <<: *backend
    command:
      - bash
      - -lc
      - >
        bench --site crm.apps.asomstudio.ai list-apps | grep -qi '^crm$'
        || (bench --site crm.apps.asomstudio.ai install-app crm && echo 'CRM installed');

volumes:
  sites:
  assets:
  db-data: